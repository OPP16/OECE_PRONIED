<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Procesos PRONIED</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-dark align-items-center" href="#">
                <img src="assets/img1.png" alt="Logo" class="logo">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-house-door-fill"></i>
                            Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-info-circle-fill"></i> Acerca
                            de</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <br />
    <div class="container-fluid">
        <h1 class="text-center"><strong>PROCESOS PRONIED</strong></h1>
        <br />

        <div class="row">
            <div class="col">
                <!-- üîπ CARDS DE OBJETO CONTRATACI√ìN -->
                <h5 class="">Por Objeto de Contrataci√≥n</h5>
                <div class="row" id="cardsContainerObjetos"></div>
            </div>
            <div class="col">
                <!-- üîπ CARDS DE NOMENCLATURA -->
                <h5 class="">Por Tipo de Nomenclatura</h5>
                <div class="row" id="cardsContainerNomenclatura"></div>
            </div>
        </div>
        <hr>
                

        <button id="btnDescargarExcel" class="">‚¨áÔ∏è Descargar Excel</button>

        <table id="tablaProcesos" class="display">
            <thead>
                <tr>
                    <th>N¬∞</th>
                    <th>Fecha Publicaci√≥n</th>
                    <th>Nomenclatura</th>
                    <th>Objeto Contrataci√≥n</th>
                    <th>Descripci√≥n Objeto</th>
                    <th>VR / VE / Cuant√≠a de la contrataci√≥n</th>
                    <th>Moneda</th>
                    <th>Cronograma</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>
    <script>
        async function cargarDatos() {
            const response = await fetch("procesos_pronied_con_cronograma.json");
            const data = await response.json();

            // === üìä TOTALES POR OBJETO DE CONTRATACI√ìN ===
            const totalesObjeto = {};
            data.forEach(p => {
                const tipo = p["Objeto Contrataci√≥n"].trim() || "Sin clasificar";
                totalesObjeto[tipo] = (totalesObjeto[tipo] || 0) + 1;
            });

            const colores1 = ["bg-success"];
            const colores2 = ["bg-info"];
            const cardsContainerObjetos = document.getElementById("cardsContainerObjetos");
            cardsContainerObjetos.innerHTML = "";

            Object.entries(totalesObjeto).forEach(([tipo, cantidad], i) => {
                const color = colores1[i % colores1.length];
                const cardHTML = `
                  <div class="col-lg-2 col-md-3 col-sm-4 col-5 mb-1">
                    <div class="card text-white ${color} stat-card">
                      <div class="m-1 text-center">
                        <div class="stat-label">${tipo}</div>
                        <div class="stat-value">${cantidad}</div>
                      </div>
                    </div>
                  </div>
                `;
                cardsContainerObjetos.insertAdjacentHTML("beforeend", cardHTML);
            });

            // === üìä TOTALES POR PREFIJO DE NOMENCLATURA ===
            const totalesNomen = {};
            data.forEach(p => {
                const nom = p.Nomenclatura?.trim() || "";
                const prefijo = nom.split("-")[0]?.trim().toUpperCase() || "SIN PREFIJO";
                totalesNomen[prefijo] = (totalesNomen[prefijo] || 0) + 1;
            });

            const cardsContainerNomenclatura = document.getElementById("cardsContainerNomenclatura");
            cardsContainerNomenclatura.innerHTML = "";

            Object.entries(totalesNomen).forEach(([prefijo, cantidad], i) => {
                const color = colores2[i % colores2.length];
                const cardHTML = `
                  <div class="col-lg-2 col-md-3 col-sm-4 col-5 mb-1">
                    <div class="card text-white ${color} stat-card">
                      <div class="m-1 text-center">
                        <div class="stat-label">${prefijo}</div>
                        <div class="stat-value">${cantidad}</div>
                      </div>
                    </div>
                  </div>
                `;
                cardsContainerNomenclatura.insertAdjacentHTML("beforeend", cardHTML);
            });

            // === üìã LLENAR TABLA ===
            const tbody = document.querySelector("#tablaProcesos tbody");
            data.forEach(item => {
                const cronograma = "<ul style='margin:0; padding-left:16px;'>" +
                    item.Cronograma.map(c =>
                        `<li><b>${c.Etapa}</b>: ${c["Fecha Inicio"]} ‚Üí ${c["Fecha Fin"]}</li>`
                    ).join("") +
                    "</ul>";

                const fila = document.createElement("tr");
                fila.innerHTML = `
                  <td>${item["N¬∞"]}</td>
                  <td>${item["Fecha Publicaci√≥n"]}</td>
                  <td>${item.Nomenclatura}</td>
                  <td>${item["Objeto Contrataci√≥n"]}</td>
                  <td>${item["Descripci√≥n Objeto"]}</td>
                  <td>${item["VR/VE"]}</td>
                  <td>${item.Moneda}</td>
                  <td>${cronograma}</td>
                `;
                tbody.appendChild(fila);
            });

            // === üìë DATATABLE ===
            $('#tablaProcesos').DataTable({
                pageLength: 10,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });

            // === üì• EXPORTAR EXCEL ===
            document.getElementById("btnDescargarExcel").addEventListener("click", () => {
                descargarExcel(data);
            });
        }

        // === üì§ FUNCI√ìN EXPORTAR EXCEL ===
        function descargarExcel(datos) {
            const wb = XLSX.utils.book_new();

            const etapasSet = new Set();
            datos.forEach(p => p.Cronograma.forEach(c => etapasSet.add(c.Etapa.trim())));
            const etapas = Array.from(etapasSet);

            const planilla = datos.map(p => {
                const fila = {
                    N: p["N¬∞"],
                    Entidad: p.Entidad,
                    Fecha_Publicaci√≥n: p["Fecha Publicaci√≥n"],
                    Nomenclatura: p.Nomenclatura,
                    Objeto: p["Objeto Contrataci√≥n"],
                    Descripci√≥n: p["Descripci√≥n Objeto"],
                    Moneda: p.Moneda,
                    Versi√≥n_SEACE: p["Versi√≥n SEACE"]
                };

                etapas.forEach(et => {
                    const etapa = p.Cronograma.find(c => c.Etapa.trim() === et);
                    fila[`${et}_FInicio`] = etapa ? etapa["Fecha Inicio"] : "";
                    fila[`${et}_FFin`] = etapa ? etapa["Fecha Fin"] : "";
                });

                return fila;
            });

            const ws = XLSX.utils.json_to_sheet(planilla);
            XLSX.utils.book_append_sheet(wb, ws, "Procesos PRONIED");

            const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
            saveAs(new Blob([wbout], { type: "application/octet-stream" }), "procesos_pronied.xlsx");
        }

        cargarDatos();

        
    </script>
</body>

</html>
